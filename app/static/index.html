<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GL Reconciliation</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: linear-gradient(135deg, #0b1224 0%, #111c3d 40%, #0f3b51 100%);
      --panel: rgba(255,255,255,0.06);
      --panel-strong: rgba(255,255,255,0.12);
      --accent: #22d3ee;
      --accent-2: #4f46e5;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --danger: #f87171;
      --success: #22c55e;
      --warning: #facc15;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
    }
    header {
      padding: 32px 24px 12px;
    }
    h1 {
      margin: 0;
      font-size: 32px;
      letter-spacing: -0.5px;
    }
    p.lede {
      margin: 6px 0 0;
      color: var(--muted);
      max-width: 820px;
    }
    main {
      padding: 10px 24px 40px;
    }
    .card {
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 18px 20px;
      box-shadow: 0 30px 70px rgba(0,0,0,0.24);
      backdrop-filter: blur(10px);
    }
    .card strong { color: #fff; }
    label {
      font-size: 13px;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
    }
    input[type="file"], input[type="number"], input[type="date"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-size: 14px;
    }
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }
    button {
      background: linear-gradient(120deg, var(--accent), var(--accent-2));
      border: none;
      color: #0b1021;
      font-weight: 600;
      padding: 12px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 15px;
      width: 100%;
      transition: transform 0.08s ease, box-shadow 0.08s ease;
      box-shadow: 0 10px 30px rgba(34,211,238,0.3);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }
    button:hover:not(:disabled) { transform: translateY(-1px); }
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
    }
    .pill {
      background: var(--panel-strong);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 12px;
      border-radius: 12px;
    }
    .pill .label { color: var(--muted); font-size: 12px; }
    .pill .value { font-size: 18px; margin-top: 4px; }
    .status-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .status-table th, .status-table td {
      padding: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      text-align: left;
    }
    .status-table th { color: var(--muted); font-weight: 500; }
    .chip {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      display: inline-block;
      font-weight: 600;
    }
    .chip.green { background: rgba(34,197,94,0.18); color: #6ee7b7; }
    .chip.yellow { background: rgba(250,204,21,0.18); color: #facc15; }
    .chip.orange { background: rgba(249,115,22,0.18); color: #fb923c; }
    .chip.red { background: rgba(248,113,113,0.18); color: #f87171; }
    .muted { color: var(--muted); }
    .issues { margin: 0; padding-left: 18px; color: #fbbf24; }
    .flex-between { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .divider { height: 1px; background: rgba(255,255,255,0.08); margin: 14px 0; }
    .tagline { font-size: 13px; color: var(--muted); }
    .download {
      background: linear-gradient(120deg, #6ee7b7, #22c55e);
      box-shadow: 0 10px 30px rgba(34,197,94,0.24);
      color: #0a121f;
    }
    a.download-link {
      color: #6ee7b7;
      text-decoration: none;
      font-weight: 600;
    }
    @media (max-width: 640px) {
      header, main { padding: 18px 16px; }
      button { width: 100%; }
    }
  </style>
</head>
<body>
  <header>
    <h1>GL Reconciliation Workspace</h1>
    <p class="lede">Upload GL (A), Subledger (B), and the mapping matrix to reconcile, preview key stats, and download a formatted Excel with dashboard and exception pivots.</p>
  </header>
  <main class="grid">
    <section class="card">
      <div class="flex-between">
        <div>
          <strong>Input Files</strong>
          <div class="tagline">XLSX or CSV. We keep everything in-memory; no external calls.</div>
        </div>
        <div class="chip green" id="status-chip">Ready</div>
      </div>
      <div class="divider"></div>
      <form id="recon-form">
        <label for="gl-file">GL file (File A)</label>
        <input type="file" id="gl-file" name="gl_file" accept=".csv,.xlsx" required>
        <label for="src-file">Subledger / Source file (File B)</label>
        <input type="file" id="src-file" name="src_file" accept=".csv,.xlsx" required>
        <label for="map-file">Mapping matrix</label>
        <input type="file" id="map-file" name="mapping_file" accept=".csv,.xlsx" required>
        <div class="row" style="margin-top:12px;">
          <div>
            <label for="amount-tol">Amount tolerance (AMOUNT_TOL)</label>
            <input type="number" step="0.01" id="amount-tol" name="amount_tol" placeholder="1.00" />
          </div>
          <div>
            <label for="date-tol">Date tolerance in days (DATE_TOL)</label>
            <input type="number" step="1" id="date-tol" name="date_tol" placeholder="2" />
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <div>
            <label for="date-from">Date from (YYYY-MM-DD)</label>
            <input type="date" id="date-from" name="date_from" />
          </div>
          <div>
            <label for="date-to">Date to (YYYY-MM-DD)</label>
            <input type="date" id="date-to" name="date_to" />
          </div>
        </div>
        <div style="margin-top:16px;">
          <button type="submit" id="run-btn">Run reconciliation</button>
        </div>
      </form>
    </section>

    <section class="card">
      <div class="flex-between">
        <div>
          <strong>Snapshot</strong>
          <div class="tagline">Auto-refreshes after each run.</div>
        </div>
        <a id="download-link" class="download-link" href="#" style="display:none;">Download Excel</a>
      </div>
      <div class="divider"></div>
      <div class="status-grid" id="kpi-grid">
        <div class="pill">
          <div class="label">Total rows</div>
          <div class="value" id="kpi-total">-</div>
        </div>
        <div class="pill">
          <div class="label">Exact matches</div>
          <div class="value" id="kpi-exact">-</div>
        </div>
        <div class="pill">
          <div class="label">Near matches</div>
          <div class="value" id="kpi-near">-</div>
        </div>
        <div class="pill">
          <div class="label">Mismatches</div>
          <div class="value" id="kpi-mismatch">-</div>
        </div>
        <div class="pill">
          <div class="label">Unmatched A</div>
          <div class="value" id="kpi-unmatched-a">-</div>
        </div>
        <div class="pill">
          <div class="label">Unmatched B</div>
          <div class="value" id="kpi-unmatched-b">-</div>
        </div>
      </div>
      <div class="divider"></div>
      <div>
        <strong>Status breakdown</strong>
        <table class="status-table" id="status-table">
          <thead>
            <tr><th>Status</th><th>Count</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="divider"></div>
      <div>
        <strong>Issues & data quality</strong>
        <ul class="issues" id="issues-list">
          <li class="muted">None yet.</li>
        </ul>
      </div>
    </section>
  </main>
  <script>
    const form = document.getElementById("recon-form");
    const runBtn = document.getElementById("run-btn");
    const statusChip = document.getElementById("status-chip");
    const downloadLink = document.getElementById("download-link");
    const issuesList = document.getElementById("issues-list");

    const KPI_MAP = {
      "total_rows": "kpi-total",
      "exact_matches": "kpi-exact",
      "near_matches": "kpi-near",
      "mismatches": "kpi-mismatch",
      "unmatched_a": "kpi-unmatched-a",
      "unmatched_b": "kpi-unmatched-b"
    };

    const STATUS_COLORS = {
      "EXACT_MATCH": "green",
      "NEAR_MATCH": "yellow",
      "MAPPING_ISSUE": "orange",
      "MISMATCH": "red",
      "UNMATCHED_A": "red",
      "UNMATCHED_B": "red"
    };

    function setStatus(text, color) {
      statusChip.textContent = text;
      statusChip.className = `chip ${color}`;
    }

    function updateKPIs(overview) {
      Object.entries(KPI_MAP).forEach(([key, id]) => {
        document.getElementById(id).textContent = overview?.[key] ?? "-";
      });
    }

    function renderStatusTable(statusCounts) {
      const tbody = document.querySelector("#status-table tbody");
      tbody.innerHTML = "";
      if (!statusCounts || statusCounts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" class="muted">No results yet.</td></tr>';
        return;
      }
      statusCounts.forEach(row => {
        const tr = document.createElement("tr");
        const chipClass = STATUS_COLORS[row.status] || "yellow";
        tr.innerHTML = `<td><span class="chip ${chipClass}">${row.status}</span></td><td>${row.count}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderIssues(issues = [], dq = []) {
      issuesList.innerHTML = "";
      const combined = [...issues, ...dq];
      if (combined.length === 0) {
        issuesList.innerHTML = '<li class="muted">None detected.</li>';
        return;
      }
      combined.forEach(item => {
        const li = document.createElement("li");
        li.textContent = item;
        issuesList.appendChild(li);
      });
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      setStatus("Working...", "yellow");
      runBtn.disabled = true;
      downloadLink.style.display = "none";
      const formData = new FormData(form);
      try {
        const res = await fetch("/api/reconcile", {
          method: "POST",
          body: formData
        });
        if (!res.ok) {
          throw new Error(`Request failed: ${res.status}`);
        }
        const data = await res.json();
        const summary = data.summary;
        updateKPIs(summary.overview);
        renderStatusTable(summary.status_counts);
        renderIssues(summary.issues, summary.data_quality_flags);
        if (data.download_url) {
          downloadLink.href = data.download_url;
          downloadLink.style.display = "inline-block";
          downloadLink.textContent = "Download Excel";
        }
        setStatus("Complete", "green");
      } catch (err) {
        console.error(err);
        setStatus("Error", "red");
        renderIssues([err.message]);
      } finally {
        runBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
